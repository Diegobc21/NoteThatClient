<!-- Popup -->
@if (popupEnabled) {
<app-popup-menu
  #popupMenuTemplate
  (emittedOption)="handlePopupOption($event)"
  [popupPosition]="getPopupPosition()"
  [options]="popupOptions"
></app-popup-menu>
}

<!--Deleting note-->
@if (isDeleteOverlayVisible) {
<app-overlay
  (onCloseEvent)="toggleDeleteOverlay()"
  (onAcceptEvent)="deleteNote(selectedNote!)"
>
  <h1 class="text-center font-bold">¿Seguro que deseas eliminar esta nota?</h1>
  <app-note-default [note]="selectedNote!"></app-note-default>
</app-overlay>
}

<!--  Editing note  -->
<app-overlay
  *ngIf="isEditingNote"
  [disableAccept]="editingFormIsEmpty"
  (onCloseEvent)="toggleIsEditingNote()"
  (onAcceptEvent)="submitEditing()"
>
  <div class="overflow-hidden">
    <h1 class="text-center font-bold text-xl mb-2">Editar nota</h1>
    <div
      class="rounded-xl bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 p-0.5 shadow-sm transition mt-4"
    >
      <div class="rounded-[10px] bg-white dark:bg-gray-950 p-4 sm:p-6">
        <form (ngSubmit)="submitEditing()">
          <input
            #editingTitle
            class="dark:bg-gray-950 placeholder-gray-400 px-4 py-2 rounded-md mb-4 w-full focus:outline-none dark:focus:bg-gray-700 bg-gray-50 hover:bg-transparent dark:hover:bg-gray-700"
            type="text"
            placeholder="Título (obligatorio)*"
            [(ngModel)]="editingNote.title"
            (ngModelChange)="setEditingFormIsEmpty()"
            required
          />
          <div class="flex flex-col">
            <textarea
              #editingContent
              class="dark:bg-gray-950 placeholder-gray-400 px-4 py-2 rounded-md mb-2 focus:outline-none dark:focus:bg-gray-700 bg-gray-50 hover:bg-transparent dark:hover:bg-gray-700"
              rows="3"
              placeholder="Contenido"
              [value]="editingNote.content"
            ></textarea>
          </div>
        </form>
      </div>
    </div>
  </div>
</app-overlay>

<div
  class="relative max-h-[calc(80svh)] overflow-auto"
>
  <div *ngIf="!(showSpinner | async)" class="sticky top-0 z-10 w-full pb-2 bg-gray-50 dark:bg-gray-950">
    <div class="flex flex-row justify-center relative">
      <button
        (click)="toggleIsAddingNote()"
        class="bg-gradient-to-r to-green-500 via-blue-500 from-purple-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded block sm:inline-block"
      >
        @if (isAddingNote) { Cancelar } @else {
        <lucide-icon name="plus"></lucide-icon>
        }
      </button>
    </div>

    <div
      [@slideDown]="isAddingNote ? 'visible' : 'hidden'"
      [@slideUp]="isAddingNote ? 'visible' : 'hidden'"
      class="overflow-hidden"
    >
      <div
        class="mt-2 max-w-md mx-auto rounded-xl bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 p-0.5 transition shadow-sm"
      >
        <div class="rounded-[10px] bg-gray-50 dark:bg-gray-950 p-2 sm:p-3">
          <h1 class="text-2xl font-bold mb-2">Nueva nota</h1>
          <form (ngSubmit)="submitNote()">
            <input
              class="block placeholder-gray-600 dark:placeholder-gray-400 focus:bg-gray-200 bg-gray-100 hover:bg-gray-50 dark:text-white dark:bg-gray-800 dark:hover:bg-gray-900 dark:focus:bg-gray-900 w-full p-2 mb-2 rounded"
              type="text"
              placeholder="*Título"
              [(ngModel)]="newNote.title"
              required
            />
            <div class="flex flex-col">
              <textarea
                class="block placeholder-gray-600 dark:placeholder-gray-400 focus:bg-gray-200 bg-gray-100 hover:bg-gray-50 dark:text-white dark:bg-gray-800 dark:hover:bg-gray-900 dark:focus:bg-gray-900 w-full p-2 mb-2 rounded"
                rows="3"
                placeholder="Contenido"
                [(ngModel)]="newNote.content"
              ></textarea>
              <div class="flex flex-row justify-end space-x-2">
                <!--              <app-color-selector></app-color-selector>-->
                <button
                  class="bg-purple-500 hover:bg-purple-700 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
                  type="submit"
                  [disabled]="addingFormIsEmpty"
                >
                  Crear
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="max-w-md mx-auto">
    <ol class="relative border-s border-gray-200 dark:border-gray-700">
      @if (showSpinner | async) {
      <li class="ms-2 mb-2">
        <div
          class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"
        ></div>
        <time
          class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-400"
        >
          <div
            class="animate-pulse h-2 w-24 bg-slate-300 dark:bg-slate-700 rounded"
          ></div>
        </time>
        <div *ngFor="let _ of [].constructor(3)">
          <div class="max-w-md mx-auto my-2">
            <app-note-loading></app-note-loading>
          </div>
        </div>
      </li>
      } @else { @for (note of noteList; let i = $index; track note) {
      <li class="ms-2 mb-2">
        @if (isDifferentMonth(i)) {
        <div
          class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"
        ></div>
        <time
          class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-400"
          >{{ getTimeLineDate(note.creationDate) }}
        </time>
        } @else {
        <div
          class="absolute bg-gray-200 border border-white dark:border-gray-900"
        ></div>
        }
        <app-note-default
          [note]="note"
          (click)="openPopup(note, $event)"
        ></app-note-default>
      </li>
      } @empty {
      <div class="mt-4">
        <app-alert
          *ngIf="showAlert"
          [type]="AlertType.WARNING"
          (onClose)="modalClosed()"
          [message]="'Aún no tienes ninguna nota'"
        >
        </app-alert>
      </div>
      } }
    </ol>
  </div>
</div>
