<!-- Popup -->
@if (popupEnabled) {
  <app-popup-menu
    #popupMenuTemplate
    (emittedOption)="handlePopupOption($event)"
    [popupPosition]="getPopupPosition()"
    [options]="popupOptions"
  ></app-popup-menu>
}

<!--Deleting note-->
@if (isDeleteOverlayVisible) {
  <app-overlay
    (onCloseEvent)="toggleDeleteOverlay()"
    (onAcceptEvent)="deleteNote(selectedNote!)"
  >
    <h1 class="text-center font-bold">¿Seguro que deseas eliminar esta nota?</h1>
    <div
      class="rounded-xl bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 p-0.5 shadow-sm mt-4 is-note"
    >
      <div class="rounded-[10px] bg-gray-50 dark:bg-gray-950 p-4 sm:p-6">
        <time class="block text-xs opacity-80">
          {{ getNoteDate(selectedNote!.creationDate) }}
        </time>
        <div class="flex flex-row justify-between">
          <div>
            <h3 class="mt-0.5 text-lg font-bold">
              {{ selectedNote!.title }}
            </h3>

            <h4 class="mt-0.5 text-sm font-medium">
              {{ selectedNote!.content }}
            </h4>
          </div>
        </div>
      </div>
    </div>
  </app-overlay>
}

<!--  Editing note  -->
<app-overlay
  *ngIf="isEditingNote"
  [disableAccept]="editingFormIsEmpty"
  (onCloseEvent)="toggleIsEditingNote()"
  (onAcceptEvent)="submitEditing()"
>
  <div class="overflow-hidden">
    <h1 class="text-center font-bold text-xl mb-2">Editar nota</h1>
    <div
      class="rounded-xl bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 p-0.5 shadow-sm transition mt-4"
    >
      <div class="rounded-[10px] bg-gray-950 p-4 sm:p-6">
        <form (ngSubmit)="submitEditing()">
          <input
            #editingTitle
            class="bg-gray-950 text-white placeholder-gray-400 px-4 py-2 rounded-md mb-4 w-full focus:outline-none focus:bg-gray-700 hover:bg-gray-700"
            type="text"
            placeholder="Título (obligatorio)*"
            [(ngModel)]="editingNote.title"
            (ngModelChange)="setEditingFormIsEmpty()"
            required
          />
          <div class="flex flex-col">
            <textarea
              #editingContent
              class="bg-gray-950 text-white placeholder-gray-400 px-4 py-2 rounded-md mb-2 focus:outline-none focus:bg-gray-700 hover:bg-gray-700"
              rows="3"
              placeholder="Contenido"
              [value]="editingNote.content"
            ></textarea>
          </div>
        </form>
      </div>
    </div>
  </div>
</app-overlay>

<div class="max-w-md mx-auto">
  <div class="flex flex-row justify-center relative">
    <button
      (click)="toggleIsAddingNote()"
      class="bg-gradient-to-r to-green-500 via-blue-500 from-purple-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded block sm:inline-block"
    >
      {{ isAddingNote ? "Cancelar" : "Añadir nota" }}
    </button>
  </div>

  <div
    [@slideDown]="isAddingNote ? 'visible' : 'hidden'"
    [@slideUp]="isAddingNote ? 'visible' : 'hidden'"
    class="overflow-hidden"
  >
    <div
      class="rounded-xl bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 p-0.5 transition shadow-sm mt-4"
    >
      <div class="rounded-[10px] bg-gray-50 dark:bg-gray-950 p-4 sm:p-6">
        <h1 class="text-2xl font-bold mb-2">Nueva nota</h1>
        <form (ngSubmit)="submitNote()">
          <input
            class="block placeholder-gray-600 dark:placeholder-gray-400 focus:bg-gray-200 bg-gray-100 hover:bg-gray-50 dark:text-white dark:bg-gray-800 dark:hover:bg-gray-900 dark:focus:bg-gray-900 w-full p-2 mb-2 rounded"
            type="text"
            placeholder="*Título"
            [(ngModel)]="newNote.title"
            required
          />
          <div class="flex flex-col">
            <textarea
              class="block placeholder-gray-600 dark:placeholder-gray-400 focus:bg-gray-200 bg-gray-100 hover:bg-gray-50 dark:text-white dark:bg-gray-800 dark:hover:bg-gray-900 dark:focus:bg-gray-900 w-full p-2 mb-2 rounded"
              rows="3"
              placeholder="Contenido"
              [(ngModel)]="newNote.content"
            ></textarea>
            <div class="flex flex-row justify-end space-x-2">
              <!--              <app-color-selector></app-color-selector>-->
              <button
                class="bg-purple-500 hover:bg-purple-700 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
                type="submit"
                [disabled]="addingFormIsEmpty"
              >
                Crear
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  @if (showSpinner | async) {
    <ol class="relative border-s border-gray-200 dark:border-gray-700">
      <li class="ms-4 pt-3">
        <div
          class="absolute w-3 h-3 bg-gray-200 rounded-full -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"
        ></div>
        <time
          class="animate-pulse mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-400"
        >
          <div class="h-2 w-24 bg-slate-700 rounded"></div>
        </time>
        <div *ngFor="let _ of [].constructor(3)">
          <div class="max-w-md mx-auto">
            <app-loading-note></app-loading-note>
          </div>
        </div>
      </li>
    </ol>
  } @else {
    @for (note of noteList; let i = $index; track note) {
      <ol class="relative border-s border-gray-200 dark:border-gray-700">
        <li class="ms-4 pt-3">
          @if (isDifferentMonth(i)) {
            <div
              class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"
            ></div>
            <time
              class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-400"
            >{{ getTimeLineDate(note.creationDate) }}
            </time
            >
          } @else {
            <div
              class="absolute h-3 bg-gray-200 mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"
            ></div>
          }
          <div
            (click)="enablePopup(note, $event)"
            id="note"
            class="rounded-xl bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 p-0.5 shadow-md transition-shadow hover:shadow-sm mt-2 is-note cursor-pointer"
          >
            <div class="rounded-[10px] bg-gray-100 dark:bg-gray-950 p-2 sm:py-2 sm:px-4">
              <time
                class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-500"
              >
                {{ getNoteDate(note.creationDate) }}
              </time>
              <div class="flex flex-row justify-between">
                <div>
                  <h3 class="text-lg font-semibold ">
                    {{ note.title }}
                  </h3>
                  <p class="text-base font-normal text-gray-500 dark:text-gray-400">
                    {{ note.content }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </li>
      </ol>
    } @empty {
      <div class="mt-4">
        <app-alert
          *ngIf="showAlert"
          [type]="AlertType.WARNING"
          (onClose)="modalClosed()"
          [message]="'Aún no tienes ninguna nota'"
        >
        </app-alert>
      </div>
    }
  }
</div>
